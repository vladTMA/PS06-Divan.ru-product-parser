# Парсер товаров Divan.ru

Проект для парсинга товаров из раздела "Освещение" интернет-магазина Divan.ru с сохранением результатов в различных форматах.

## Описание

Проект использует Selenium WebDriver с браузером Brave для парсинга товаров со страниц раздела "Освещение" сайта Divan.ru. Поддерживается парсинг как одной страницы, так и всех страниц раздела с автоматической фильтрацией дубликатов.

## Возможности

- ✅ Парсинг одной страницы раздела
- ✅ Парсинг всех страниц раздела с автоматической пагинацией
- ✅ Фильтрация дубликатов между страницами
- ✅ Сохранение данных в CSV, JSON, XLSX и HTML форматах
- ✅ Автоматическое определение валюты товаров
- ✅ Обработка ошибок и таймаутов
- ✅ Задержки между запросами для избежания блокировки
- ✅ Использование браузера Brave через ChromeDriver

## Структура проекта

```
PS06/
├── myproject/              # Основной пакет проекта
│   ├── scraper.py         # Модуль парсинга
│   ├── saver.py           # Модуль сохранения данных
│   ├── output/            # Директория для сохранения результатов
│   └── __init__.py
├── tests/                 # Тесты
│   ├── test_scraper.py
│   ├── test_saver.py
│   └── test_utf8_encoding.py
├── run.py                 # Основной скрипт для запуска парсинга всех страниц
├── main.py                # Альтернативный скрипт с открытием HTML в Brave
├── chromedriver.exe       # ChromeDriver для Brave браузера (используется из корня проекта)
├── requirements.txt       # Зависимости проекта
└── pytest.ini            # Конфигурация pytest
```

## Установка

1. Клонируйте репозиторий или скачайте проект

2. Создайте виртуальное окружение:
```bash
python -m venv .venv
```

3. Активируйте виртуальное окружение:
```bash
# Windows PowerShell
.venv\Scripts\Activate.ps1

# Windows CMD
.venv\Scripts\activate.bat
```

4. Установите зависимости:
```bash
pip install -r requirements.txt
```

5. Убедитесь, что у вас установлен браузер Brave:
   - По умолчанию используется путь: `C:\Program Files\BraveSoftware\Brave-Browser\Application\brave.exe`
   - Если Brave установлен в другом месте, измените путь в `myproject/scraper.py` (строка 105)
   - В корне проекта должен находиться файл `chromedriver.exe` для работы с Brave браузером

## Использование

### Парсинг всех страниц раздела

Основной способ запуска - через `run.py`:

```bash
python run.py
```

Этот скрипт:
- Парсит все страницы раздела "Освещение" (начиная с 0)
- Сохраняет данные в `myproject/output/` в форматах CSV, JSON, XLSX и HTML
- Использует задержку 5 секунд между страницами для избежания блокировки

### Парсинг одной страницы

Альтернативный способ через `main.py`:

```bash
python main.py
```

Этот скрипт:
- Парсит только первую страницу раздела
- Сохраняет данные
- Открывает HTML файл в браузере Brave

### Программное использование

```python
from myproject import scraper, saver

# Парсинг одной страницы
data = scraper.scrape_section("https://www.divan.ru/category/svet", headless=False)

# Парсинг всех страниц раздела
data = scraper.scrape_all_pages(
    "https://www.divan.ru/category/svet?sort=0",
    headless=False,
    max_pages=50,
    delay_between_pages=5
)

# Сохранение данных
saver.save_all(data)  # Сохраняет в CSV, JSON, XLSX
saver.render_html(data)  # Генерирует HTML файл
```

## Формат данных

Каждый товар представлен словарем со следующими полями:

```python
{
    "name": "Название товара",
    "price": "Цена",
    "currency": "Валюта (руб., $, €)",
    "url": "Ссылка на товар",
    "instock_text": "Текст о наличии"
}
```

## Сохранение данных

Данные сохраняются в директорию `myproject/output/`:

- **results.csv** - данные в формате CSV с русскими заголовками
- **results.json** - данные в формате JSON
- **results.xlsx** - данные в формате Excel с русскими заголовками
- **results.html** - красиво оформленная HTML таблица с результатами

## Тестирование

Запуск тестов:

```bash
pytest
```

Запуск с подробным выводом:

```bash
pytest -v
```

## Настройки

### Изменение задержки между страницами

В `run.py` можно изменить параметр `delay_between_pages`:

```python
data = scraper.scrape_all_pages(
    "https://www.divan.ru/category/svet?sort=0",
    headless=False,
    max_pages=50,
    delay_between_pages=10  # Увеличьте до 10 секунд при проблемах с блокировкой
)
```

### Изменение пути к Brave браузеру

В `myproject/scraper.py` (строка 105) измените путь:

```python
options.binary_location = r"путь\к\brave.exe"
```

### Headless режим

Для запуска браузера в фоновом режиме (без открытия окна):

```python
data = scraper.scrape_section(url, headless=True)
```

## Технические детали

### Использование Brave браузера

Проект использует браузер Brave вместо стандартного Chrome:
- Brave запускается через ChromeDriver из файла `chromedriver.exe` в корне проекта
- Путь к браузеру по умолчанию: `C:\Program Files\BraveSoftware\Brave-Browser\Application\brave.exe`
- Если Brave установлен в другом месте, измените путь в `myproject/scraper.py` (строка 105)
- Проект использует режим инкогнито и отключение кэша для избежания блокировок

### Работа с драйвером

- Проект использует `chromedriver.exe` из корня проекта
- Если драйвер не найден или не работает, будет попытка использовать системный ChromeDriver
- Убедитесь, что версия ChromeDriver совместима с установленной версией Brave браузера

## Зависимости

- `selenium` - для работы с браузером
- `webdriver-manager` - для автоматической загрузки ChromeDriver (резервный вариант)
- `pandas` - для работы с данными и сохранения в Excel
- `openpyxl` - для работы с Excel файлами
- `jinja2` - для генерации HTML
- `pytest` - для тестирования

## Особенности

- **Автоматическая фильтрация дубликатов** - товары с одинаковым URL не добавляются повторно
- **Умная прокрутка страницы** - автоматическая прокрутка для загрузки всех товаров (lazy loading)
- **Обработка ошибок** - при ошибках на одной странице парсинг продолжается со следующей
- **Проверка переадресаций** - автоматическое обнаружение проблем с переадресацией
- **Гибкое сохранение** - работает с неполными данными (если каких-то полей нет)

## Решение проблем

### Сайт блокирует запросы

Если появляется ошибка "слишком много переадресаций":
1. Увеличьте `delay_between_pages` до 10-15 секунд
2. Подождите 10-15 минут перед повторным запуском
3. Используйте headless режим: `headless=True`

### Файл XLSX не сохраняется

Если файл открыт в Excel, он будет сохранен с временным именем (например, `results_1234567890.xlsx`).

### ChromeDriver не найден

Проект использует `chromedriver.exe` из корня проекта. Если возникают проблемы, убедитесь, что:
- Файл `chromedriver.exe` находится в корне проекта
- Версия ChromeDriver совместима с установленной версией Brave браузера
- Браузер Brave установлен и обновлен
- Если драйвер не работает, проект попробует использовать системный ChromeDriver

## Лицензия

Проект создан в образовательных целях.

